<link rel="stylesheet" href="/css/reviews.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">


<h1>{{bnb.title}}</h1>
<p><strong>City:</strong> {{bnb.city}}</p>
<p><strong>Address:</strong> {{bnb.address}}</p>
<p><strong>Price per night:</strong> ${{bnb.pricePerNight}}</p>
<p><strong>Bedrooms:</strong> {{bnb.bedrooms}}</p>
<p><strong>Bathrooms:</strong> {{bnb.bathrooms}}</p>
<p><strong>Amenities:</strong> {{#each bnb.amenities}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}</p>
<p><strong>Average Rating:</strong> {{bnb.averageRating}}</p>

<h2>Description</h2>
<p>{{bnb.description}}</p>

<hr>

<h2>Reviews</h2>
{{#if user}}
<button id="addReviewBtn" class="btn btn-primary mb-2">Add Review</button>

<!-- Modal -->
<div class="modal fade" id="addReviewModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addReviewForm" method="POST" action="/reviews/user/addReview" >
        <div class="modal-header">
          <h5 class="modal-title">Add Review</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="propertyId" value="{{property._id}}">
          <div class="mb-3">
            <label>Rating</label>
            <select name="rating" class="form-control">
              <option value="5">5 - Excellent</option>
              <option value="4">4 - Good</option>
              <option value="3">3 - Fair</option>
              <option value="2">2 - Poor</option>
              <option value="1">1 - Very Poor</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Comment</label>
            <textarea name="comment" class="form-control" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Submit</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
{{else}}
  <p><a href="/users/login">Sign in to add a review</a></p>
{{/if}}

{{#if reviews.length}}
<ul class="reviews-list">
  {{#each reviews}}
  <li class="review-item">
    <strong>{{this.author}}</strong>: {{this.comment}} (Rating: {{this.rating}})
    <br>
    <button class="like-btn" data-id="{{this._id}}">
      ğŸ‘ Like (<span class="likes-count">{{this.likes}}</span>)
    </button>
  </li>
  {{/each}}
</ul>
{{else}}
<p>No reviews yet</p>
{{/if}}

<!-- å¼•å…¥ç‚¹èµé€»è¾‘ -->
<script src="/js/reviews.js"></script>
<script>
document.getElementById('addReviewBtn').addEventListener('click', function() {
  // Bootstrap5çš„å¼¹çª—
  var modal = new bootstrap.Modal(document.getElementById('addReviewModal'));
  document.getElementById('addReviewForm').style.display = '';
  modal.show();
});

// å¯é€‰ï¼š é…ç½®AJAXæäº¤ï¼Œæå‡ä½“éªŒ
document.getElementById('addReviewForm').addEventListener('submit', async function(e){
  e.preventDefault();

  const form = e.target;
  const data = {
    listingId: form.listingId.value,
    rating: form.rating.value,
    comment: form.comment.value
  };

  const res = await fetch('/reviews/user/addReview', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });

  const result = await res.json();
  if (result.success) {
    alert('Review added!');
    // å¯é€‰ï¼šåˆ·æ–°è¯„è®ºåŒº
    location.reload();
  } else {
    alert('Failed: ' + result.message);
  }
});
</script>

<script>
  // ç”¨äºç‚¹èµæ›´æ–°çš„AJAXè¯·æ±‚
  function likeReview(reviewId) {
    fetch(`/reviews/${reviewId}/like`, {
      method: 'POST',
    })
    .then((response) => response.json())
    .then((data) => {
      if (data.success) {
        // æ›´æ–°ç‚¹èµæ•°
        document.getElementById(`likes-${reviewId}`).textContent = `Likes: ${data.likes}`;
      }
    });
  }

  // è¯·æ±‚æ–°çš„è¯„åˆ†æ•°æ®
  function updateRating() {
    fetch('/property/averageRating', { method: 'GET' })
      .then(response => response.json())
      .then(data => {
        // æ›´æ–°é¡µé¢ä¸Šçš„è¯„åˆ†æ•°æ®
        document.getElementById('averageRating').textContent = `Average Rating: ${data.averageRating}`;
      });
  }

  // é¡µé¢åŠ è½½æ—¶ï¼Œæ›´æ–°è¯„åˆ†
  window.onload = function () {
    updateRating();  // è·å–å¹¶æ›´æ–°è¯„åˆ†
  }
</script>